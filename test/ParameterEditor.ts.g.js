"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _Dropdown = _interopRequireDefault(require("../controls/Dropdown"));

var _App = _interopRequireDefault(require("Native/App"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class ParametersEditor {
  constructor() {
    _defineProperty(this, "haveSelected", false);

    _defineProperty(this, "developer", false);

    _defineProperty(this, "visible", false);

    _defineProperty(this, "sections", []);

    _defineProperty(this, "parameters", []);

    _defineProperty(this, "mappedSections", {});
  }

  open() {
    this.filterMenu();
    this.visible = true;
  }

  close() {
    this.visible = false;
  }

  clear() {
    this.sections.length = 0;
    this.parameters.length = 0;
    this.mappedSections = {};
  }

  addSection(name) {
    var section = new MenuSection(this, name);
    this.sections.push(section);
    this.mappedSections[name] = section;
    return section;
  }

  filterMenu(developer) {
    if (developer === undefined) developer = this.developer;

    for (var i = 0; i < this.sections.length; i++) {
      this.sections[i].visible = false;

      for (var j = 0; j < this.sections[i].parameters.length; j++) {
        this.sections[i].parameters[j].visible = !this.sections[i].parameters[j].developer || developer;
        if (this.sections[i].parameters[j].visible) this.sections[i].visible = true;
      }
    }

    if (!this.haveSelected) {
      for (var j = 0; j < this.sections.length; j++) {
        if (this.sections[j].visible) {
          this.onSelected(this.sections[j]);
          return;
        }
      }
    } else if (!developer) {
      for (var i = 0; i < this.sections.length; i++) {
        if (this.sections[i].selected && !this.sections[i].visible) {
          for (var j = 0; j < this.sections.length; j++) {
            if (this.sections[j].visible) {
              this.onSelected(this.sections[j]);
              return;
            }
          }
        }
      }
    }
  }

  onSelected(arg) {
    this.parameters = arg.parameters;
    this.haveSelected = true;

    for (var i = 0; i < this.sections.length; i++) this.sections[i].selected = this.sections[i] === arg;

    _App.default.queryEntityParameters(arg.name);
  }

  developerChanged(arg) {
    this.filterMenu(arg.value);
  }

  onEntityParameter(section, parameter, value) {
    if (!this.mappedSections[section] || !this.mappedSections[section].mappedParameters[parameter]) return;
    this.mappedSections[section].mappedParameters[parameter].resetValue(value);
  }

}

exports.default = ParametersEditor;

// Dynamic menu parameters
class MenuParameter {
  constructor(section, name, type, visibility, defaultValue, dropdownValues, units) {
    _defineProperty(this, "section", void 0);

    _defineProperty(this, "key", void 0);

    _defineProperty(this, "developer", void 0);

    _defineProperty(this, "name", void 0);

    _defineProperty(this, "units", void 0);

    _defineProperty(this, "type", void 0);

    _defineProperty(this, "dropdown", void 0);

    _defineProperty(this, "value", void 0);

    _defineProperty(this, "oldValue", void 0);

    _defineProperty(this, "dirty", void 0);

    _defineProperty(this, "even", void 0);

    _defineProperty(this, "visible", void 0);

    this.section = section;
    this.key = name;
    this.developer = visibility == "developer";
    this.name = name;
    this.units = units;

    if (dropdownValues) {
      this.type = "dropdown";
      this.dropdown = new _Dropdown.default(value => {
        if (this.value === value.name) return;
        this.value = value.name;
        this.valueChanged({
          value: value.name
        });
      });
      var array = dropdownValues.split(",");

      for (var i = 0; i < array.length; i++) {
        var item = {
          name: array[i].trim()
        };
        this.dropdown.items.push(item);
      }
    } else if (type == "real") {
      this.type = "decimal";
    } else if (type == "integer") {
      this.type = "integer";
    } else if (type == "boolean") {
      this.type = "switch";
    } else {
      // list:real || matrix || list:integer || ...
      this.type = "text";
    }

    this.resetValue(defaultValue);
  }

  resetValue(value) {
    if (this.type == "switch") this.value = value == "1" || value && value.toLowerCase() == "true";else this.value = value;
    if (this.type == "dropdown") for (var i = 0; i < this.dropdown.items.length; i++) if (this.dropdown.items[i].name == this.value) this.dropdown.select(this.dropdown.items[i]);
    this.oldValue = this.value; //console.log("reset " + this.section.name + "/" + this.key + " = " + this.value);
  }

  valueChanged(arg) {
    // Defer applying text or number values to DUNE until focusLost(),
    // avoiding sending new values every time a new character is typed.
    if (this.type == "text" || this.type == "number") this.dirty = true;else this.applyValue(arg.value);
  }

  focusLost() {
    if (this.dirty) this.applyValue(this.value);
  }

  applyValue(value) {
    this.dirty = false;
    if (this.oldValue == value) return;
    this.oldValue = value; //console.log("apply " + this.section.name + "/" + this.key + " = " + value);

    _App.default.setEntityParameter(this.section.name, this.key, value);
  }

}

class MenuSection {
  constructor(editor, name) {
    _defineProperty(this, "editor", void 0);

    _defineProperty(this, "name", void 0);

    _defineProperty(this, "visible", true);

    _defineProperty(this, "selected", false);

    _defineProperty(this, "parameters", []);

    _defineProperty(this, "mappedParameters", {});

    this.editor = editor;
    this.name = name;
  }

  addParameter(name, type, visibility, defaultValue, dropdownValues, units) {
    var parameter = new MenuParameter(this, name, type, visibility, defaultValue, dropdownValues, units);
    this.parameters.push(parameter);
    this.mappedParameters[name] = parameter;
    parameter.even = this.parameters.length % 2 == 0;
    return parameter;
  }

  onSelect() {
    this.editor.onSelected(this);
  }

}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlBhcmFtZXRlckVkaXRvci50cyJdLCJuYW1lcyI6WyJQYXJhbWV0ZXJzRWRpdG9yIiwib3BlbiIsImZpbHRlck1lbnUiLCJ2aXNpYmxlIiwiY2xvc2UiLCJjbGVhciIsInNlY3Rpb25zIiwibGVuZ3RoIiwicGFyYW1ldGVycyIsIm1hcHBlZFNlY3Rpb25zIiwiYWRkU2VjdGlvbiIsIm5hbWUiLCJzZWN0aW9uIiwiTWVudVNlY3Rpb24iLCJwdXNoIiwiZGV2ZWxvcGVyIiwidW5kZWZpbmVkIiwiaSIsImoiLCJoYXZlU2VsZWN0ZWQiLCJvblNlbGVjdGVkIiwic2VsZWN0ZWQiLCJhcmciLCJOYXRpdmVBcHAiLCJxdWVyeUVudGl0eVBhcmFtZXRlcnMiLCJkZXZlbG9wZXJDaGFuZ2VkIiwidmFsdWUiLCJvbkVudGl0eVBhcmFtZXRlciIsInBhcmFtZXRlciIsIm1hcHBlZFBhcmFtZXRlcnMiLCJyZXNldFZhbHVlIiwiTWVudVBhcmFtZXRlciIsImNvbnN0cnVjdG9yIiwidHlwZSIsInZpc2liaWxpdHkiLCJkZWZhdWx0VmFsdWUiLCJkcm9wZG93blZhbHVlcyIsInVuaXRzIiwia2V5IiwiZHJvcGRvd24iLCJEcm9wZG93biIsInZhbHVlQ2hhbmdlZCIsImFycmF5Iiwic3BsaXQiLCJpdGVtIiwidHJpbSIsIml0ZW1zIiwidG9Mb3dlckNhc2UiLCJzZWxlY3QiLCJvbGRWYWx1ZSIsImRpcnR5IiwiYXBwbHlWYWx1ZSIsImZvY3VzTG9zdCIsInNldEVudGl0eVBhcmFtZXRlciIsImVkaXRvciIsImFkZFBhcmFtZXRlciIsImV2ZW4iLCJvblNlbGVjdCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOzs7Ozs7QUFFZSxNQUFNQSxnQkFBTixDQUF1QjtBQUFBO0FBQUEsMENBQ1YsS0FEVTs7QUFBQSx1Q0FFYixLQUZhOztBQUFBLHFDQUdmLEtBSGU7O0FBQUEsc0NBSVIsRUFKUTs7QUFBQSx3Q0FLSixFQUxJOztBQUFBLDRDQU1iLEVBTmE7QUFBQTs7QUFR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QixDQUF6QixJQUE4QixDQUEvQztBQUNBLFdBQU9xQixTQUFQO0FBQ0g7O0FBRUQ2QixFQUFBQSxRQUFRLEdBQVM7QUFDYixTQUFLSCxNQUFMLENBQVlsQyxVQUFaLENBQXVCLElBQXZCO0FBQ0g7O0FBdkJhIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IERyb3Bkb3duIGZyb20gXCIuLi9jb250cm9scy9Ecm9wZG93blwiO1xuaW1wb3J0IE5hdGl2ZUFwcCBmcm9tIFwiTmF0aXZlL0FwcFwiO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBQYXJhbWV0ZXJzRWRpdG9yIHtcbiAgICBoYXZlU2VsZWN0ZWQ6IGJvb2xlYW4gPSBmYWxzZTtcbiAgICBkZXZlbG9wZXI6IGJvb2xlYW4gPSBmYWxzZTtcbiAgICB2aXNpYmxlOiBib29sZWFuID0gZmFsc2U7XG4gICAgc2VjdGlvbnM6IE1lbnVTZWN0aW9uW10gPSBbXTtcbiAgICBwYXJhbWV0ZXJzOiBNZW51UGFyYW1ldGVyW10gPSBbXTtcbiAgICBtYXBwZWRTZWN0aW9uczoge30gPSB7fTtcblxuICAgIG9wZW4oKTogdm9pZCB7XG4gICAgICAgIHRoaXMuZmlsdGVyTWVudSgpO1xuICAgICAgICB0aGlzLnZpc2libGUgPSB0cnVlO1xuICAgIH1cblxuICAgIGNsb3NlKCk6IHZvaWQge1xuICAgICAgICB0aGlzLnZpc2libGUgPSBmYWxzZTtcbiAgICB9XG5cbiAgICBjbGVhcigpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5zZWN0aW9ucy5sZW5ndGggPSAwO1xuICAgICAgICB0aGlzLnBhcmFtZXRlcnMubGVuZ3RoID0gMDtcbiAgICAgICAgdGhpcy5tYXBwZWRTZWN0aW9ucyA9IHt9O1xuICAgIH1cblxuICAgIGFkZFNlY3Rpb24obmFtZTogc3RyaW5nKTogTWVudVNlY3Rpb24ge1xuICAgICAgICB2YXIgc2VjdGlvbiA9IG5ldyBNZW51U2VjdGlvbih0aGlzLCBuYW1lKTtcbiAgICAgICAgdGhpcy5zZWN0aW9ucy5wdXNoKHNlY3Rpb24pO1xuICAgICAgICB0aGlzLm1hcHBlZFNlY3Rpb25zW25hbWVdID0gc2VjdGlvbjtcbiAgICAgICAgcmV0dXJuIHNlY3Rpb247XG4gICAgfVxuXG4gICAgZmlsdGVyTWVudShkZXZlbG9wZXI/OiBib29sZWFuKTogdm9pZCB7XG4gICAgICAgIGlmIChkZXZlbG9wZXIgPT09IHVuZGVmaW5lZClcbiAgICAgICAgICAgIGRldmVsb3BlciA9IHRoaXMuZGV2ZWxvcGVyO1xuXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5zZWN0aW9ucy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgdGhpcy5zZWN0aW9uc1tpXS52aXNpYmxlID0gZmFsc2U7XG5cbiAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgdGhpcy5zZWN0aW9uc1tpXS5wYXJhbWV0ZXJzLmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZWN0aW9uc1tpXS5wYXJhbWV0ZXJzW2pdLnZpc2libGUgPSAhdGhpcy5zZWN0aW9uc1tpXS5wYXJhbWV0ZXJzW2pdLmRldmVsb3BlciB8fCBkZXZlbG9wZXI7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuc2VjdGlvbnNbaV0ucGFyYW1ldGVyc1tqXS52aXNpYmxlKVxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNlY3Rpb25zW2ldLnZpc2libGUgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCF0aGlzLmhhdmVTZWxlY3RlZCkge1xuICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCB0aGlzLnNlY3Rpb25zLmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuc2VjdGlvbnNbal0udmlzaWJsZSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLm9uU2VsZWN0ZWQodGhpcy5zZWN0aW9uc1tqXSk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAoIWRldmVsb3Blcikge1xuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLnNlY3Rpb25zLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuc2VjdGlvbnNbaV0uc2VsZWN0ZWQgJiYgIXRoaXMuc2VjdGlvbnNbaV0udmlzaWJsZSkge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHRoaXMuc2VjdGlvbnMubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnNlY3Rpb25zW2pdLnZpc2libGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9uU2VsZWN0ZWQodGhpcy5zZWN0aW9uc1tqXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgb25TZWxlY3RlZChhcmc6IE1lbnVTZWN0aW9uKTogdm9pZCB7XG4gICAgICAgIHRoaXMucGFyYW1ldGVycyA9IGFyZy5wYXJhbWV0ZXJzO1xuICAgICAgICB0aGlzLmhhdmVTZWxlY3RlZCA9IHRydWU7XG5cbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLnNlY3Rpb25zLmxlbmd0aDsgaSsrKVxuICAgICAgICAgICAgdGhpcy5zZWN0aW9uc1tpXS5zZWxlY3RlZCA9IHRoaXMuc2VjdGlvbnNbaV0gPT09IGFyZztcblxuICAgICAgICBOYXRpdmVBcHAucXVlcnlFbnRpdHlQYXJhbWV0ZXJzKGFyZy5uYW1lKTtcbiAgICB9XG5cbiAgICBkZXZlbG9wZXJDaGFuZ2VkKGFyZzogYW55KTogdm9pZCB7XG4gICAgICAgIHRoaXMuZmlsdGVyTWVudShhcmcudmFsdWUpO1xuICAgIH1cblxuICAgIG9uRW50aXR5UGFyYW1ldGVyKHNlY3Rpb246IHN0cmluZywgcGFyYW1ldGVyOiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgaWYgKCF0aGlzLm1hcHBlZFNlY3Rpb25zW3NlY3Rpb25dIHx8XG4gICAgICAgICAgICAhdGhpcy5tYXBwZWRTZWN0aW9uc1tzZWN0aW9uXS5tYXBwZWRQYXJhbWV0ZXJzW3BhcmFtZXRlcl0pXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgdGhpcy5tYXBwZWRTZWN0aW9uc1tzZWN0aW9uXS5tYXBwZWRQYXJhbWV0ZXJzW3BhcmFtZXRlcl0ucmVzZXRWYWx1ZSh2YWx1ZSk7XG4gICAgfVxufVxuXG50eXBlIFZhbHVlID0gc3RyaW5nIHwgYm9vbGVhbjtcblxuaW50ZXJmYWNlIERhdGEge1xuICAgIHZhbHVlOiBWYWx1ZTtcbn1cblxuaW50ZXJmYWNlIEl0ZW0ge1xuICAgIG5hbWU6IHN0cmluZztcbn1cblxuLy8gRHluYW1pYyBtZW51IHBhcmFtZXRlcnNcbmNsYXNzIE1lbnVQYXJhbWV0ZXIge1xuICAgIHNlY3Rpb246IE1lbnVTZWN0aW9uO1xuICAgIGtleTogc3RyaW5nO1xuICAgIGRldmVsb3BlcjogYm9vbGVhbjtcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgdW5pdHM6IHN0cmluZztcbiAgICB0eXBlOiBzdHJpbmc7XG4gICAgZHJvcGRvd246IERyb3Bkb3duPEl0ZW0+O1xuICAgIHZhbHVlOiBWYWx1ZTtcbiAgICBvbGRWYWx1ZTogVmFsdWU7XG4gICAgZGlydHk6IGJvb2xlYW47XG4gICAgZXZlbjogYm9vbGVhbjtcbiAgICB2aXNpYmxlOiBib29sZWFuO1xuXG4gICAgY29uc3RydWN0b3Ioc2VjdGlvbjogTWVudVNlY3Rpb24sIG5hbWU6IHN0cmluZywgdHlwZTogc3RyaW5nLCB2aXNpYmlsaXR5OiBzdHJpbmcsIGRlZmF1bHRWYWx1ZTogc3RyaW5nLCBkcm9wZG93blZhbHVlczogc3RyaW5nLCB1bml0czogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMuc2VjdGlvbiA9IHNlY3Rpb247XG4gICAgICAgIHRoaXMua2V5ID0gbmFtZTtcbiAgICAgICAgdGhpcy5kZXZlbG9wZXIgPSB2aXNpYmlsaXR5ID09IFwiZGV2ZWxvcGVyXCI7XG4gICAgICAgIHRoaXMubmFtZSA9IG5hbWU7XG4gICAgICAgIHRoaXMudW5pdHMgPSB1bml0cztcblxuICAgICAgICBpZiAoZHJvcGRvd25WYWx1ZXMpIHtcbiAgICAgICAgICAgIHRoaXMudHlwZSA9IFwiZHJvcGRvd25cIjtcbiAgICAgICAgICAgIHRoaXMuZHJvcGRvd24gPSBuZXcgRHJvcGRvd24oKHZhbHVlOiBJdGVtKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMudmFsdWUgPT09IHZhbHVlLm5hbWUpXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICAgICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZS5uYW1lO1xuICAgICAgICAgICAgICAgIHRoaXMudmFsdWVDaGFuZ2VkKHt2YWx1ZTogdmFsdWUubmFtZX0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB2YXIgYXJyYXkgPSBkcm9wZG93blZhbHVlcy5zcGxpdChcIixcIik7XG5cbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICB2YXIgaXRlbSA9IHtuYW1lOiBhcnJheVtpXS50cmltKCl9O1xuICAgICAgICAgICAgICAgIHRoaXMuZHJvcGRvd24uaXRlbXMucHVzaChpdGVtKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmICh0eXBlID09IFwicmVhbFwiKSB7XG4gICAgICAgICAgICB0aGlzLnR5cGUgPSBcImRlY2ltYWxcIjtcbiAgICAgICAgfSBlbHNlIGlmICh0eXBlID09IFwiaW50ZWdlclwiKSB7XG4gICAgICAgICAgICB0aGlzLnR5cGUgPSBcImludGVnZXJcIjtcbiAgICAgICAgfSBlbHNlIGlmICh0eXBlID09IFwiYm9vbGVhblwiKSB7XG4gICAgICAgICAgICB0aGlzLnR5cGUgPSBcInN3aXRjaFwiO1xuICAgICAgICB9IGVsc2UgeyAvLyBsaXN0OnJlYWwgfHwgbWF0cml4IHx8IGxpc3Q6aW50ZWdlciB8fCAuLi5cbiAgICAgICAgICAgIHRoaXMudHlwZSA9IFwidGV4dFwiO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5yZXNldFZhbHVlKGRlZmF1bHRWYWx1ZSk7XG4gICAgfVxuXG4gICAgcmVzZXRWYWx1ZSh2YWx1ZTogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLnR5cGUgPT0gXCJzd2l0Y2hcIilcbiAgICAgICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZSA9PSBcIjFcIiB8fCB2YWx1ZSAmJiB2YWx1ZS50b0xvd2VyQ2FzZSgpID09IFwidHJ1ZVwiO1xuICAgICAgICBlbHNlXG4gICAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7XG5cbiAgICAgICAgaWYgKHRoaXMudHlwZSA9PSBcImRyb3Bkb3duXCIpXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuZHJvcGRvd24uaXRlbXMubGVuZ3RoOyBpKyspXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuZHJvcGRvd24uaXRlbXNbaV0ubmFtZSA9PSB0aGlzLnZhbHVlKVxuICAgICAgICAgICAgICAgICAgICB0aGlzLmRyb3Bkb3duLnNlbGVjdCh0aGlzLmRyb3Bkb3duLml0ZW1zW2ldKTtcblxuICAgICAgICB0aGlzLm9sZFZhbHVlID0gdGhpcy52YWx1ZTtcbiAgICAgICAgLy9jb25zb2xlLmxvZyhcInJlc2V0IFwiICsgdGhpcy5zZWN0aW9uLm5hbWUgKyBcIi9cIiArIHRoaXMua2V5ICsgXCIgPSBcIiArIHRoaXMudmFsdWUpO1xuICAgIH1cblxuICAgIHZhbHVlQ2hhbmdlZChhcmc6IERhdGEpOiB2b2lkIHtcbiAgICAgICAgLy8gRGVmZXIgYXBwbHlpbmcgdGV4dCBvciBudW1iZXIgdmFsdWVzIHRvIERVTkUgdW50aWwgZm9jdXNMb3N0KCksXG4gICAgICAgIC8vIGF2b2lkaW5nIHNlbmRpbmcgbmV3IHZhbHVlcyBldmVyeSB0aW1lIGEgbmV3IGNoYXJhY3RlciBpcyB0eXBlZC5cbiAgICAgICAgaWYgKHRoaXMudHlwZSA9PSBcInRleHRcIiB8fCB0aGlzLnR5cGUgPT0gXCJudW1iZXJcIilcbiAgICAgICAgICAgIHRoaXMuZGlydHkgPSB0cnVlO1xuICAgICAgICBlbHNlXG4gICAgICAgICAgICB0aGlzLmFwcGx5VmFsdWUoYXJnLnZhbHVlKTtcbiAgICB9XG5cbiAgICBmb2N1c0xvc3QoKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLmRpcnR5KVxuICAgICAgICAgICAgdGhpcy5hcHBseVZhbHVlKHRoaXMudmFsdWUpO1xuICAgIH1cblxuICAgIGFwcGx5VmFsdWUodmFsdWU6IFZhbHVlKTogdm9pZCB7XG4gICAgICAgIHRoaXMuZGlydHkgPSBmYWxzZTtcblxuICAgICAgICBpZiAodGhpcy5vbGRWYWx1ZSA9PSB2YWx1ZSlcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICB0aGlzLm9sZFZhbHVlID0gdmFsdWU7XG4gICAgICAgIC8vY29uc29sZS5sb2coXCJhcHBseSBcIiArIHRoaXMuc2VjdGlvbi5uYW1lICsgXCIvXCIgKyB0aGlzLmtleSArIFwiID0gXCIgKyB2YWx1ZSk7XG4gICAgICAgIE5hdGl2ZUFwcC5zZXRFbnRpdHlQYXJhbWV0ZXIodGhpcy5zZWN0aW9uLm5hbWUsIHRoaXMua2V5LCB2YWx1ZSk7XG4gICAgfVxufVxuXG5jbGFzcyBNZW51U2VjdGlvbiB7XG4gICAgZWRpdG9yOiBQYXJhbWV0ZXJzRWRpdG9yO1xuICAgIG5hbWU6IHN0cmluZztcbiAgICB2aXNpYmxlOiBib29sZWFuID0gdHJ1ZTtcbiAgICBzZWxlY3RlZDogYm9vbGVhbiA9IGZhbHNlO1xuICAgIHBhcmFtZXRlcnM6IE1lbnVQYXJhbWV0ZXJbXSA9IFtdO1xuICAgIG1hcHBlZFBhcmFtZXRlcnM6IHt9ID0ge307XG5cbiAgICBjb25zdHJ1Y3RvcihlZGl0b3I6IFBhcmFtZXRlcnNFZGl0b3IsIG5hbWU6IHN0cmluZykge1xuICAgICAgICB0aGlzLmVkaXRvciA9IGVkaXRvcjtcbiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTtcbiAgICB9XG5cbiAgICBhZGRQYXJhbWV0ZXIobmFtZTogc3RyaW5nLCB0eXBlOiBzdHJpbmcsIHZpc2liaWxpdHk6IHN0cmluZywgZGVmYXVsdFZhbHVlOiBzdHJpbmcsIGRyb3Bkb3duVmFsdWVzOiBzdHJpbmcsIHVuaXRzOiBzdHJpbmcpOiBNZW51UGFyYW1ldGVyIHtcbiAgICAgICAgdmFyIHBhcmFtZXRlciA9IG5ldyBNZW51UGFyYW1ldGVyKHRoaXMsIG5hbWUsIHR5cGUsIHZpc2liaWxpdHksIGRlZmF1bHRWYWx1ZSwgZHJvcGRvd25WYWx1ZXMsIHVuaXRzKTtcbiAgICAgICAgdGhpcy5wYXJhbWV0ZXJzLnB1c2gocGFyYW1ldGVyKTtcbiAgICAgICAgdGhpcy5tYXBwZWRQYXJhbWV0ZXJzW25hbWVdID0gcGFyYW1ldGVyO1xuICAgICAgICBwYXJhbWV0ZXIuZXZlbiA9IHRoaXMucGFyYW1ldGVycy5sZW5ndGggJSAyID09IDA7XG4gICAgICAgIHJldHVybiBwYXJhbWV0ZXI7XG4gICAgfVxuXG4gICAgb25TZWxlY3QoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuZWRpdG9yLm9uU2VsZWN0ZWQodGhpcyk7XG4gICAgfVxufVxuIl19
